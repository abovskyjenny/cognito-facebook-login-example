<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title></title>
	<link rel="stylesheet" type="text/css" href="">
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.686.0.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

</head>
<style>

	.facebook {
		width: 200px;
		height: 30px;
		margin-right: 50px;
		margin-bottom: 50px;

		background-color: royalblue;
	}

	.default {
		width: 200px;
		height: 30px;
		margin-right: 50px;
		margin-bottom: 50px;

		background-color: white;
	}

	.google {
		width: 200px;
		height: 30px;
		background-color: indianred;
	}

	.social {
		margin: 50px;
	}

	.welcome {
		padding: 50px;
		font-size: 20px;
		font-weight: 600;
	}

	.logout {
		display: none;
	}

	.buttons {
		display: flex;
		flex-direction: column;
	}
</style>
<script>

	var userTest = {
		"sub": "60138589-8db1-4e8e-a8c9-00afb0fe1119",
		"name": "Jenny Abba",
		"given_name": "Jenny",
		"family_name": "Abba",
		"email": "sjenia@gmail.com",
		"picture": "{\"data\":{\"height\":50,\"is_silhouette\":false,\"url\":\"https://platform-lookaside.fbsbx.com/platform/profilepic/?asid=703476370413293&height=50&width=50&ext=1593796546&hash=AeR-ISzR9GmiqUOF\",\"width\":50}}",
		"username": "facebook_703476370413293"
	};

	var user = {};
	var tokens;

	var COGNITO_CLIENT_ID = '58k8ptc6lot749m4ujh0g3av27';
	var COGNITO_DOMAIN = 'https://top10-users.auth.us-east-1.amazoncognito.com';


	const tokenUrl = `${COGNITO_DOMAIN}/oauth2/token`;
	const infoUrl = `${COGNITO_DOMAIN}/oauth2/userInfo`;
	const redirectUrl = 'http%3A%2F%2Flocalhost%3A3000';


	window.onload = async function load() {
		await initUserWelcomeMessage();
	}

	function getUrlVars() {
		var vars = {};
		var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
			vars[key] = value;
		});
		return vars;
	}


	async function initUserWelcomeMessage() {
		var params = getUrlVars();

		var codeParam = params['code'];
		if(codeParam) {
			console.log('codeParam ', codeParam);
			await login(codeParam);
			var accessToken = window.localStorage.getItem('accessToken');
			if(accessToken) {
				user = await getInfo(accessToken);
				if(user) {
					var hello = document.getElementById('hello');
					var message = 'Welcome '
					if(user.name) {
						message += user.name;
					} else {
						message += user.given_name + (user.family_name ? ` ${user.family_name}` : '') + ' !';
					}
					hello.innerText = message;
				}
			}
		}
	}


	function getProviderUrl(providerName, redirectUri) {
		var redirect = redirectUri || redirectUrl;
		var scope = 'aws.cognito.signin.user.admin%20email%20openid%20phone%20profile';
		var url;
		if(providerName) {
			url = `${COGNITO_DOMAIN}/oauth2/authorize?identity_provider=${providerName}&redirect_uri=${redirect}&response_type=code&client_id=${COGNITO_CLIENT_ID}&scope=${scope}&state=%7B%20newsletters%3A%201%7D`;
		} else {
			url = `${COGNITO_DOMAIN}/oauth2/authorize?redirect_uri=${redirect}&response_type=code&client_id=${COGNITO_CLIENT_ID}&scope=${scope}&state=%7B%20newsletters%3A%201%7D`;
		}

		return url;
	}

	function facebookLogin() {
		window.location.href = getProviderUrl('Facebook');
	}

	function googleLogin() {
		window.location.href = getProviderUrl('Google');
	}
	function defaultLogin() {
		window.location.href = getProviderUrl();
	}

	const refreshTokens = async refreshToken => {
		const body = `grant_type=refresh_token&client_id=${COGNITO_CLIENT_ID}`;
		const response = await fetch(tokenUrl, {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			body,
		});
		if (!response.ok) {
			throw Error();
		}
		const { access_token, id_token } = await response.json();
		window.localStorage.setItem('accessToken', access_token);
		window.localStorage.setItem('idToken', id_token);
		window.localStorage.setItem('refreshToken', refreshToken);
		tokens = {
			accessToken: access_token,
			idToken: id_token,
			refreshToken,
		};
	};


	const login = async code => {
		const body = `grant_type=authorization_code&client_id=${COGNITO_CLIENT_ID}&code=${code}&redirect_uri=${redirectUrl}`;
		const response = await fetch(tokenUrl, {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			body,
		});
		if (!response.ok) {
			throw Error();
		}
		const { access_token, id_token, refresh_token } = await response.json();
		window.localStorage.setItem('accessToken', access_token);
		window.localStorage.setItem('idToken', id_token);
		window.localStorage.setItem('refreshToken', refresh_token);
		tokens = {
			accessToken: access_token,
			idToken: id_token,
			refreshToken: refresh_token,
		};
	};

	const getInfo = async access_token => {
		const response = await fetch(infoUrl, {
			method: 'GET',
			headers: {
				'Authorization': `Bearer ${access_token}`,
				'Content-Type': 'application/x-www-form-urlencoded',
			},
		});
		if (!response.ok) {
			throw Error();
		}
		user = await response.json();
		window.localStorage.setItem('user', user);
		return user;
	};



</script>

<body>

<div class="social">

	<div id="hello" class="welcome">

	</div>

	<div id="buttons" class="buttons">
		<button onclick="defaultLogin()" class="default">Login</button>

		<button onclick="facebookLogin()" class="facebook">Facebook login</button>
		<button onclick="googleLogin()" class="google">Google login</button>

		<button onclick="logout()" class="logout">Logout</button>

	</div>
</div>

</body>
</html>